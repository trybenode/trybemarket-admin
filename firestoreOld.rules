rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // This rule allows anyone with your Firestore database reference to view, edit,
    // and delete all data in your Firestore database. It is useful for getting
    // started, but it is configured to expire after 30 days because it
    // leaves your app open to attackers. At that time, all client
    // requests to your Firestore database will be denied.
    //
    // Make sure to write security rules for your app before that time, or else
    // all client requests to your Firestore database will be denied until you Update
    // your rules
    // match /{document=**} {
    //   allow read, write: if request.time < timestamp.date(2025, 4, 20);
    // }
    match /users/{userId} {
  allow read: if true; 
  
   allow update: if request.auth != null && (
    request.auth.uid == userId ||  // owner can update
    // allow others to only update averageRating and totalRatings
    request.resource.data.diff(resource.data).affectedKeys().hasOnly(['averageRating', 'totalRatings'])
  );
  allow write: if request.auth != null && request.auth.uid == userId;
}
    
     match /conversation/{conversationId} {
     allow read, create: if request.auth != null;
     allow update, write: if request.auth != null && request.auth.uid in request.resource.data.participants;
    }
    
      match /products/{productId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
      match /categories/{categoryId} {
      allow read: if true;
      allow write: if request.auth != null;
      // allow write: if request.auth != null && request.auth.token.admin == true;
      
    }
      match /kycRequests/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    match /subscriptions/{userId} {
      // Allow an authenticated user to read/write only their own doc
      allow read, write: if request.auth != null
                         && request.auth.uid == userId;
    }
    
 
    match /serviceCategories/{docId} {
      allow read: if request.auth != null;
    }
    
    match /services/{serviceId} {
      allow create: if request.auth != null;
      allow read: if true; 
    }
      match /kycRequests/{userId} {
      allow create: if request.auth != null;
      allow update, write: if request.auth != null && request.auth.uid == userId;
      allow read: if request.auth != null && request.auth.uid == userId;
    }
    
   
 match /reviews/{sellerId}/userReviews/{buyerId} {
      allow read: if true;
      allow create, update: if request.auth != null && request.auth.uid == buyerId;
    
    }


    match /services/{serviceId} {
      allow read: if true;
    }
    
    // Users can only read their own admin document
    match /admins/{userId} {
      allow read: if request.auth.uid == userId;
      allow write: if false; // Prevent client-side writes, use Admin SDK only
    }
    
    // Admin users can read all users data
    match /users/{document=**} {
      allow read, list: if request.auth.uid != null && 
        exists(/databases/$(database)/documents/admins/$(request.auth.uid));
      allow write: if false; // Only via Admin SDK
    }
    
    // Admin users can read all orders
    match /orders/{document=**} {
      allow read, list: if request.auth.uid != null && 
        exists(/databases/$(database)/documents/admins/$(request.auth.uid));
      allow write: if false; // Only via Admin SDK
    }
    
    // Admin users can read all products
    match /products/{document=**} {
      allow read, list: if request.auth.uid != null && 
        exists(/databases/$(database)/documents/admins/$(request.auth.uid));
      allow write: if false; // Only via Admin SDK
    }
    
    // Admin users can read settings
    match /settings/{document=**} {
      allow read: if request.auth.uid != null && 
        exists(/databases/$(database)/documents/admins/$(request.auth.uid));
      allow write: if false; // Only via Admin SDK
    }
    
        
    // Admin users can read and update KYC requests
    match /kycRequests/{requestId} {
      allow read, list: if request.auth.uid != null && 
        exists(/databases/$(database)/documents/admins/$(request.auth.uid));
      allow update: if request.auth.uid != null && 
        exists(/databases/$(database)/documents/admins/$(request.auth.uid)) &&
        // Only allow updating these specific fields
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(
          ['status', 'reviewedBy', 'reviewedAt', 'updatedAt', 'rejectionReason']
        );
      allow create, delete: if false; // Only via Admin SDK or user app
    }
  
    
    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  

  }
}